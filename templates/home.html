{% extends 'layout.html' %}

{% block body %}
<h1><div id="welcome_text"></div></h1>
<script>
  let chatHistory = JSON.parse(
  localStorage.getItem("chat_history") || "[]"
);
  var username = localStorage.getItem("username");
  if(username === null){
    username = 'Guest'
  }
  document.getElementById('welcome_text').textContent = 'Welcome ' + username + '!';
</script>
<br>
<hr>
<table class="table table-striped">
  <tr>
    <th>ID</th>
    <th>Title</th>
    <th>Author</th>
    <th>Price</th>
    <th>Date</th>
  </tr>
  {% for course in courses %}
    <tr>
      <td>{{course.id}}</td>
      <td>{{course.title}}</td>
      <td>{{course.author}}</td>
      <td>{{course.price}}</td>
      <td>{{course.date_created.date()}}</td>
    </tr>
  {% endfor %}
</table>

<!-- Chat Button -->
<button id="chat-toggle" class="chat-toggle" 
  style="position: fixed; bottom: 10px; right: 10px; background-color: #c9774e; color: white; border-radius: 50%; padding: 15px; font-size: 20px; border: none; cursor: pointer;">üí¨
</button>

<!-- Chat Popup -->
<div id="chat-popup" class="chat-popup" style="position: fixed; bottom: 10px; right: 10px; width: 900px; height: 600px; background-color: #fff; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); display: none; flex-direction: column; overflow: hidden;">

  <div class="chat-header" style="background-color: #c9774e; padding: 10px; color: #fff; font-weight: 600; font-family: Arial, sans-serif; display: flex; justify-content: space-between; align-items: center; border-radius: 10px 10px 0 0;">
    <h5 style="margin: 0;">Qwallity Chatbot</h5>
    <div>
      <button id="clear-chat" title="Clear chat history" style="background: none; border: none; font-size: 16px; color: #fff; cursor: pointer; margin-right: 10px;">üóëÔ∏è</button>
      <button id="close-chat" style="background: none; border: none; font-size: 20px; color: #fff; cursor: pointer;">X</button> 
    </div>
  </div>

  <div id="chat-box" class="chat-box" style="padding: 10px; flex-grow: 1; overflow-y: auto; max-height: 400px;">
    <div id="chat-messages" class="chat-messages">
      <div id="loading-spinner" style="display: none; text-align: center; margin-top: 10px;">
        <img src="/static/spinner.gif" alt="Loading..." width="30" height="30">
      </div>
      <img id='robot_img' src="/static/robot.png" width="120" height="100" style="vertical-align:center">
      <div id="greeting-message" style="color: #210240;">Hi! How can I help you?</div>
    </div>
  </div>

  <div class="chat-footer" style="display: flex; flex-wrap: wrap; gap: 8px; padding: 10px; align-items: flex-start; border-top: 1px solid #eee; box-sizing: border-box;">
          <textarea id="user-input" placeholder="Type a message..."
        style="flex: 1 1 auto; min-height: 60px; max-height: 200px; overflow-y: auto; padding: 8px; border-radius: 20px; border: 1px solid #ddd; font-size: 14px; resize: none; line-height: 1.4;"></textarea>
  
    <div style="display: flex; gap: 8px; flex-shrink: 0;">
      <button id="send-button"
        style="background-color: #c9774e; border: none; padding: 10px 16px; border-radius: 20px; color: white; cursor: pointer; font-size: 14px;">
        Send
      </button>
  
      <button id="toggle-prompt" title="Toggle prompt visibility"
        style="background-color: #f0f0f0; border: none; padding: 10px 16px; border-radius: 20px; color: #333; cursor: pointer; font-size: 14px;">
        üéõÔ∏è Prompt Input
      </button>
    </div>
  </div>
  
  
<!-- Prompt Edit Modal -->
<dialog id="editPromptModal" style="width: 600px; padding: 0; border: none; border-radius: 8px; box-shadow: 0 8px 16px rgba(0,0,0,0.3);">
  <form method="dialog" style="padding: 20px;">
    <h2>Edit System Prompt</h2>
    <textarea id="systemPromptInput" rows="20" 
    style="width: 100%; min-height: 200px; font-family: 'Poppins', sans-serif; font-size: 1rem; padding: 10px; border-radius: 6px; border: 1px solid #ccc;"></textarea>  
    <div style="margin-top: 1rem; display: flex; justify-content: flex-end; gap: 10px;">
      <button type="submit" id="savePromptButton" style="background-color: #0f8e5f; border: none; padding: 10px 16px; border-radius: 20px; color: white; cursor: pointer; font-size: 14px;">Save</button>
      <button type="button" id="cancelPromptButton" style="background-color: #c9774e; border: none; padding: 10px 16px; border-radius: 20px; color: white; cursor: pointer; font-size: 14px;">Cancel</button>
    </div>
  </form>
</dialog>

<!-- Axios -->
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<style>
.message.bot {
  align-self: flex-start;
  background: #fffbe6;
  color: #210240;
  padding: 10px 16px;
  border-radius: 16px 16px 16px 4px;
  max-width: 80%;
  font-size: 15px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  margin: 5px 0;
  white-space: pre-wrap;
  word-wrap: break-word;
}
.message.user {
  align-self: flex-end;
  background: #d4eaff;
  color: #003366;
  padding: 10px 16px;
  border-radius: 16px 16px 4px 16px;
  max-width: 80%;
  font-size: 15px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
  margin: 5px 0;
  white-space: pre-wrap;
  word-wrap: break-word;
}
.chat-messages {
  display: flex;
  flex-direction: column;
}
</style>

<script>


document.getElementById("chat-toggle").onclick = function () {
  document.getElementById("chat-popup").style.display = "flex";
  this.style.display = "none";
};

document.getElementById("close-chat").onclick = function () {
  document.getElementById("chat-popup").style.display = "none";
  document.getElementById("chat-toggle").style.display = "inline-block";
};

document.getElementById("send-button").onclick = function () {
  const userInput = document.getElementById("user-input").value;
  const savedPrompt = localStorage.getItem("userPrompt") || '';  // <-- Get system prompt from localStorage

  if (userInput.trim() !== "") {
    const chatMessages = document.getElementById("chat-messages");

    const userMessage = document.createElement("div");
    userMessage.classList.add("message", "user");
    userMessage.textContent = userInput;
    chatMessages.appendChild(userMessage);
    chatHistory.push({ role: "user", content: userInput });

    if (chatHistory.length > 20) {
      chatHistory = chatHistory.slice(-20);
    }

    localStorage.setItem("chat_history", JSON.stringify(chatHistory));
    document.getElementById("greeting-message").style.display = "none";
    document.getElementById("robot_img").style.display = "none";
    document.getElementById("user-input").value = "";
    // Reset textarea to original size
    const textarea = document.getElementById("user-input");
    textarea.style.height = "60px";
    document.getElementById("loading-spinner").style.display = "block";

    // Send both message and systemPromptInput to the backend
    axios.post('/api/chat', {
      message: userInput,
      systemPromptInput: savedPrompt,
      history: chatHistory   // ‚úÖ add this
    })
    .then(response => {
      document.getElementById("loading-spinner").style.display = "none";
      const botMessage = document.createElement("div");
      botMessage.classList.add("message", "bot");
      botMessage.textContent = response.data.answer;
      chatMessages.appendChild(botMessage);
      chatHistory.push({ role: "assistant", content: response.data.answer });

      if (chatHistory.length > 20) {
        chatHistory = chatHistory.slice(-20);
      }

      localStorage.setItem("chat_history", JSON.stringify(chatHistory));
      chatMessages.scrollTop = chatMessages.scrollHeight;
    })
    .catch(error => {
      document.getElementById("loading-spinner").style.display = "none";
      console.error("Error:", error);
    });
  }
};

document.getElementById("user-input").addEventListener("keypress", function (event) {
  if (event.key === "Enter" && !event.shiftKey) {
    event.preventDefault();
    document.getElementById("send-button").click();
  }
});

document.getElementById('clear-chat').onclick = () => {
  const chatMessages = document.getElementById('chat-messages');
  [...chatMessages.querySelectorAll('.message.user, .message.bot')].forEach(el => el.remove());
  document.getElementById("greeting-message").style.display = "block";
  document.getElementById("robot_img").style.display = "inline-block";
  chatHistory = [];
  localStorage.removeItem("chat_history");
  chatMessages.scrollTop = 0;
};

document.getElementById('toggle-prompt').addEventListener('click', function () {
  const dialog = document.getElementById('editPromptModal');
  const savedPrompt = localStorage.getItem('userPrompt') || '';
  document.getElementById('systemPromptInput').value = savedPrompt;
  dialog.showModal();
});

document.getElementById('cancelPromptButton').addEventListener('click', function () {
  document.getElementById('editPromptModal').close();
});

document.getElementById('savePromptButton').addEventListener('click', function () {
  const promptVal = document.getElementById('systemPromptInput').value.trim();
  localStorage.setItem('userPrompt', promptVal);
});

// document.getElementById('editPromptModal').addEventListener('close', function () {
//   const promptVal = document.getElementById('systemPromptInput').value.trim();
//   if (promptVal) {
//     localStorage.setItem('userPrompt', promptVal);
//   }
// });

function autoResizeTextarea(textarea) {
  textarea.style.height = 'auto';
  const newHeight = Math.max(textarea.scrollHeight, 60);
  textarea.style.height = newHeight + 'px';
}

document.addEventListener('DOMContentLoaded', function () {
  const userInput = document.getElementById('user-input');
  const systemPromptInput = document.getElementById('systemPromptInput');

  // Auto-resize for user input
  if (userInput) {
    autoResizeTextarea(userInput);
    userInput.addEventListener('input', () => autoResizeTextarea(userInput));
    userInput.addEventListener('keydown', () => autoResizeTextarea(userInput));
  }

  // Auto-resize for system prompt input
  if (systemPromptInput) {
    autoResizeTextarea(systemPromptInput);
    systemPromptInput.addEventListener('input', () => autoResizeTextarea(systemPromptInput));
  }
});
</script>

{% endblock %}
